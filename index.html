<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Language Learning Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <style>
        :root {
            --aqua: #26d1ba;
            --primary: #444;
            --ol: #009682;
        }

        * {
            font-size: 13pt;
            font-family: Tahoma, sans-serif;
            color: var(--primary)
        }

        button {
            padding: 10px;
            margin: 4pt 0;
            line-height: unset;
        }

        .editor {
            margin-top: 10pt;
        }

        .editor>textarea {
            width: 100%;
            height: 200px;
            resize: none;
            font-size: 11pt;
        }

        .editor>textarea.splitted {
            height: 80vh;
        }

        .content {
            margin-top: 10pt;
        }

        .content.splitted {
            height: 80vh;
            overflow-y: auto;
        }

        .content.splitted .line * {
            font-size: 11pt;
        }

        .dword:hover {
            background-color: lightgray;
            border-radius: 4pt;
        }

        .line {
            margin-top: 8pt;
        }

        .dword {
            display: inline-block;
            margin: 0 2pt;
            padding: 2pt;
            cursor: pointer;
            user-select: none;
        }

        .splitted .dword {
            margin: 0 1pt;
            padding: 1pt;
        }

        .puzzled {
            background: var(--aqua);
            color: var(--aqua) !important;
        }

        .dword>div {
            width: 100%;
            text-align: center;
            padding-top: 2pt;
            border-radius: 4pt;
        }

        .dword>div:nth-child(2) {
            color: var(--ol);
            font-style: italic;
            font-weight: bold;
            padding: 0 1pt;
        }

        hr {
            margin: 20pt 0;
            background-color: #fff;
            border-top: 2px dashed #8c8b8b;
        }

        .hidden {
            display: none;
        }

        textarea {
            font-size: 14pt;
        }

        h3 {
            font-size: 20pt;
        }

        @media print {
            .controls {
                display: none !important;
            }

            .container {
                width: 95%;
            }

            .line * {
                font-size: 10pt !important;
            }

            h3 {
                font-size: 18pt;
            }

            .dword {
                margin: 0 1pt;
                padding: 1pt;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row" style="margin-top: 1%;margin-bottom: 1%;">
            <div class="column">
                <div class="controls row">
                    <div class="three columns">
                        <button class="editor-button button-primary" onclick="toggleEditor()">Editor</button>
                    </div>
                    <div class="three columns">
                        <button onclick="hideAll()">Hide all</button>
                        <button onclick="showAll()">Show all</button>
                    </div>
                    <div class="four columns" style="text-align: right;">
                        <button onclick="clearArea()">Clear</button>
                        <button onclick="loadTxt()">Load TXT</button>
                        <input type="file" accept=".txt" id="uploadFile" hidden="hidden" onchange="onFileInput()">
                        <button onclick="saveTxt()">Save TXT</button>
                    </div>
                    <div class="two columns" style="text-align: right;">
                        <button onclick="help()">Help</button>
                        <button onclick="doPrint()">Print</button>
                    </div>
                </div>

                <div class="row">
                    <div class="one-third column editor">
                        <textarea class="splitted" spellcheck="false" oninput="onEditorInput()"
                            placeholder="Paste text here"></textarea>
                    </div>
                    <div class="two-thirds column content splitted"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        const tip = `!!Language Learning Tool\n\ntry to+click on words and buttons\n\nпопробуй нажать на слова и кнопки\nlet's learn\nдавай изучать\n\nyour language\nтвой язык\n\n(hover a+word and press "Q" for fun)\nнаведи на+слово и нажми "Q" для веселья\n-\nwhile you're+enjoying+it\nпока тебе+это+нравится\n`
        let currentWord = "";
        renderInput()

        document.body.addEventListener('keydown', (e) => {
            if (e.code == 'KeyQ' && currentWord.length) {
                e.preventDefault()
                window.open("https://wooordhunt.ru/word/" + currentWord)
            }
        })

        function setupContent() {
            document.querySelectorAll(".dword").forEach(dw => {
                const t = dw.children[0];
                const o = dw.children[1];

                dw.onclick = () => {
                    o.classList.toggle("puzzled")
                }
                dw.onmouseenter = () => {
                    currentWord = t.textContent.trim()
                }
                dw.onmouseleave = () => {
                    currentWord = ""
                }
            })
        }

        function hideAll() {
            document.querySelectorAll(".dword").forEach(dw => {
                dw.children[1].classList.add("puzzled")
            })
        }

        function showAll() {
            document.querySelectorAll(".dword").forEach(dw => {
                dw.children[1].classList.remove("puzzled")
            })
        }

        function help() {
            if (document.querySelector(".editor").classList.contains("hidden")) {
                toggleEditor();
            }

            const text = document.querySelector(".editor>textarea").value.trim();

            if (!text.length || text == tip || confirm("Are you sure? Your text will be discarded")) {
                document.querySelector(".editor>textarea").value = tip;
                renderInput()
            }
        }

        function doPrint() {
            if (!document.querySelector(".editor").classList.contains("hidden")) {
                toggleEditor();
            }
            showAll();
            print();
        }

        function toggleEditor() {
            document.querySelector(".editor").classList.toggle("hidden")
            document.querySelector(".editor-button").classList.toggle("button-primary")
            document.querySelector(".editor>textarea").classList.toggle("splitted")
            document.querySelector(".content").classList.toggle("splitted")
            document.querySelector(".content").classList.toggle("two-thirds")
        }

        function load() {
            var saved = loadText() || ""
            if (saved.length) {
                document.querySelector(".editor>textarea").value = saved
            }
            renderInput()
        }

        function clearArea() {
            if (document.querySelector(".editor").classList.contains("hidden")) {
                toggleEditor();
            }

            const text = document.querySelector(".editor>textarea").value.trim();

            if (!text.length || text == tip || confirm("Are you sure? Your text will be discarded")) {
                document.querySelector(".editor>textarea").value = "";
                renderInput()
            }
        }

        function onEditorInput() {
            const text = renderInput()
            saveText(text)
        }

        function renderInput() {
            const text = document.querySelector(".editor>textarea").value
            console.log("editor text:")
            console.log(text)

            const parsed = parseText(text)
            console.log("parsed:")
            console.log(parsed)

            updateContent(parsed)
            setupContent()

            return text;
        }

        function updateContent(data) {
            let html = "";
            if (data.title.length) {
                html += "<h3>" + data.title + "</h3>\n"
                document.title = data.title
            }
            data.lines.forEach(l => {
                if (l.hr) {
                    html += '<hr>\n'
                } else if (l.words) {
                    html += '<div class="line">\n'
                    l.words.forEach(w => {
                        html += '<div class="dword">\n'
                        html += '<div>' + w.left + '</div>\n'
                        html += '<div>' + w.right + '</div>\n'
                        html += '</div>\n'
                    })
                    html += '</div>\n'
                }
            })
            document.querySelector("div.content").innerHTML = html;
        }

        function loadText() {
            return localStorage.getItem("text")
        }

        function saveText(text) {
            localStorage.setItem("text", text)
        }

        function parseText(text) {
            const res = {
                title: "",
                lines: []
            }
            const lines = text.trim().replaceAll("\r", "\n").replace(/\n+/g, "\n").split("\n")
            let line = [];
            lines
                .map(l => l.trim())
                .filter(l => l.length)
                .forEach(l => {
                    if (l.indexOf("!!") === 0 && !res.title.length) {
                        res.title = l.substring(2)
                    } else {
                        if (line.length == 2) {
                            res.lines.push({ tl: line[0], ol: line[1] })
                            line.length = 0
                        }
                        if (l[0] == "-") {
                            if (line.length == 1) {
                                res.lines.push({ tl: line[0] })
                                line.length = 0
                            }
                            res.lines.push({ hr: true })
                        } else {
                            line.push(l)
                        }
                    }
                })
            if (line.length) {
                res.lines.push({ tl: line[0], ol: line[1] })
            }

            res.lines.forEach(l => {
                l.words = parseWords(l.tl || "", l.ol || "")
            })

            return res;
        }

        function parseWords(left, right) {
            const leftWords = left.split(" ").map(w => w.replaceAll("+", " "))
            const rightWords = right.split(" ").map(w => w.replaceAll("+", " "))
            const res = []

            const len = Math.max(leftWords.length, rightWords.length)
            for (let i = 0; i < len; i++) {
                res.push({ left: leftWords[i] || "⚠️", right: rightWords[i] || "⚠️" })
            }

            return res
        }

        function onFileInput() {
            const input = document.getElementById("uploadFile").files[0];
            if (input) {
                readFile(input, document.querySelector(".editor>textarea"));
            }
        }

        function readFile(source, target) {
            const reader = new FileReader();
            reader.addEventListener('load', (event) => {
                target.value = event.target.result;
                document.getElementById("uploadFile").value = null;
                renderInput()
            });
            reader.readAsText(source);
        }

        function loadTxt() {
            document.getElementById("uploadFile").click()
        }

        function saveTxt() {
            let data = document.querySelector(".editor>textarea").value.trim();
            let file = document.title + '-' + Date.now() + '.txt';

            let link = document.createElement('a');
            link.download = file;
            let blob = new Blob(['' + data + ''], {
                type: 'text/plain'
            });
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
        }
    </script>
</body>

</html>